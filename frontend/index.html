<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Danoon Магазин</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div id="productsGrid"></div>
<div id="loading">Загрузка...</div>

<script>
/* =========================
   ИНИЦИАЛИЗАЦИЯ TELEGRAM
========================= */
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

let products = [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];
const user = tg.initDataUnsafe.user;

/* =========================
   ЗАГРУЗКА ТОВАРОВ ИЗ БД
========================= */
function loadProducts() {
    fetch('http://localhost:3000/products')
        .then(res => res.json())
        .then(data => {
            products = data;
            displayProducts(products);
            document.getElementById('loading').style.display = 'none';
        })
        .catch(err => {
            console.error(err);
            document.getElementById('loading').textContent = 'Ошибка загрузки';
        });
}

/* =========================
   ОТОБРАЖЕНИЕ ТОВАРОВ
========================= */
function displayProducts(list) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    list.forEach(product => {
        grid.innerHTML += `
            <div style="border:1px solid #ddd; padding:10px; margin:10px">
                <img src="${product.image}"
                     style="width:100%;max-width:300px"
                     onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                <h3>${product.name}</h3>
                <p>${product.description || ''}</p>
                <b>${product.price} ₽</b><br><br>
                <button onclick="addToCart(${product.id})">В корзину</button>
            </div>
        `;
    });
}

/* =========================
   КОРЗИНА
========================= */
function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;

    const item = cart.find(i => i.id === id);
    if (item) {
        item.quantity++;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            image: product.image,
            quantity: 1
        });
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    alert('Добавлено в корзину');
}

/* =========================
   ОФОРМЛЕНИЕ ЗАКАЗА
========================= */
function checkout() {
    const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);

    fetch('http://localhost:3000/order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            telegram_id: user?.id,
            cart,
            total
        })
    })
    .then(res => res.json())
    .then(() => {
        cart = [];
        localStorage.removeItem('cart');
        alert('Заказ оформлен');
    });
}

/* =========================
   СТАРТ
========================= */
document.addEventListener('DOMContentLoaded', loadProducts);
</script>

</body>
</html>
